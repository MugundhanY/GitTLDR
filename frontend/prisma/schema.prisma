generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  name                String
  avatarUrl           String?              @map("avatar_url")
  githubId            String               @unique @map("github_id")
  githubLogin         String?              @map("github_login")
  bio                 String?
  location            String?
  company             String?
  blog                String?
  twitterUsername     String?              @map("twitter_username")
  publicRepos         Int?                 @map("public_repos")
  publicGists         Int?                 @map("public_gists")
  followers           Int?
  following           Int?
  hireable            Boolean?
  githubCreatedAt     DateTime?            @map("github_created_at")
  credits             Int                  @default(150)
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  githubAccessToken   String?              @map("github_access_token")
  repositories        Repository[]
  transactions        Transaction[]
  // Relations for tracking who created items
  createdMeetings     Meeting[]            @relation("MeetingCreatedBy")
  createdQuestions    Question[]           @relation("QuestionCreatedBy")
  uploadedAttachments QuestionAttachment[] @relation("AttachmentUploadedBy")

  @@map("users")
  Meeting Meeting[]
}

model Repository {
  id                  String               @id @default(cuid())
  name                String
  fullName            String               @map("full_name")
  owner               String
  url                 String
  description         String?
  language            String?
  stars               Int                  @default(0)
  forks               Int                  @default(0)
  isPrivate           Boolean              @default(false) @map("is_private")
  processed           Boolean              @default(false)
  summary             String?
  embeddingStatus     RepositoryStatus     @default(PENDING) @map("embedding_status")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  userId              String               @map("user_id")
  avatarUrl           String?              @map("avatar_url")
  fileCount           Int?                 @map("file_count")
  totalSize           Int?                 @map("total_size")
  watchersCount       Int?                 @map("watchers_count")
  commits             Commit[]
  questions           Question[]
  meetings            Meeting[]
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  files               RepositoryFile[]
  questionAttachments QuestionAttachment[]

  @@map("repositories")
}

model RepositoryFile {
  id           String     @id @default(cuid())
  path         String
  name         String
  type         String
  size         Int
  summary      String?
  language     String?
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  repositoryId String     @map("repository_id")
  fileKey      String?    @map("file_key")
  fileUrl      String?    @map("file_url")
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@unique([repositoryId, path])
  @@map("repository_files")
}

model Commit {
  id           String           @id @default(cuid())
  sha          String           @unique
  message      String
  authorName   String           @map("author_name")
  authorEmail  String           @map("author_email")
  authorAvatar String?          @map("author_avatar")
  timestamp    DateTime
  url          String
  summary      String?
  filesChanged Int              @map("files_changed")
  createdAt    DateTime         @default(now()) @map("created_at")
  repositoryId String           @map("repository_id")
  status       RepositoryStatus @default(PENDING)
  repository   Repository       @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@map("commits")
}

model Question {
  id                  String               @id @default(cuid())
  query               String
  answer              String
  confidenceScore     Float                @map("confidence_score")
  relevantFiles       Json                 @map("relevant_files")
  isFavorite          Boolean              @default(false) @map("is_favorite")
  tags                String[]             @default([])
  category            String?
  notes               String?
  attachments         Json                 @default("[]")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  userId              String               @map("user_id")
  repositoryId        String               @map("repository_id")
  repository          Repository           @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  createdBy           User                 @relation("QuestionCreatedBy", fields: [userId], references: [id], onDelete: Cascade)
  questionAttachments QuestionAttachment[]

  @@map("questions")
}

model QuestionAttachment {
  id               String     @id @default(cuid())
  fileName         String     @map("file_name")
  originalFileName String     @map("original_file_name")
  fileSize         Int        @map("file_size")
  fileType         String     @map("file_type")
  uploadUrl        String     @map("upload_url")
  backblazeFileId  String?    @map("backblaze_file_id")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  uploadedBy       String     @map("uploaded_by")
  questionId       String?    @map("question_id")
  repositoryId     String     @map("repository_id")
  uploadedByUser   User       @relation("AttachmentUploadedBy", fields: [uploadedBy], references: [id], onDelete: Cascade)
  question         Question?  @relation(fields: [questionId], references: [id], onDelete: SetNull)
  repository       Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@map("question_attachments")
}

model Transaction {
  id          String          @id @default(cuid())
  type        TransactionType
  credits     Int
  amount      Float?
  description String
  stripeId    String?         @map("stripe_id")
  createdAt   DateTime        @default(now()) @map("created_at")
  userId      String          @map("user_id")
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

model Meeting {
  id               String        @id @default(uuid())
  title            String
  full_transcript  String?
  summary          String?
  status           MeetingStatus @default(UPLOADED)
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  source           String?
  language         String?
  raw_audio_path   String?
  num_segments     Int?
  meeting_length   Float?        // Duration in seconds
  participants String[] // Array of participant names or IDs
  meeting_segments MeetingSegment[]
  userId           String?       @map("user_id")
  user             User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("meetings")
  Repository Repository[]
  User User[] @relation("MeetingCreatedBy")
}

model MeetingSegment {
  id           String   @id @default(uuid())
  meeting_id   String
  meeting      Meeting  @relation(fields: [meeting_id], references: [id])
  segment_index Int
  title        String
  summary      String
  excerpt      String
  segment_text String
  start_time   Float
  end_time     Float
  embedding    String? // or Bytes? or reference to Qdrant
  created_at   DateTime @default(now())

  @@unique([meeting_id, segment_index], name: "meeting_id_segment_index")
  @@map("meeting_segments")
}

model Feedback {
  id        String   @id @default(cuid())
  answerId  String?  // QnA answer id (nullable for step/deep)
  stepId    String?  // Step id (nullable for qna/deep)
  type      String   // 'qna' | 'deep' | 'step'
  value     String   // 'like' | 'dislike'
  userId    String?  // User id (optional)
  createdAt DateTime @default(now())

  @@unique([answerId, userId, type], name: "answerId_userId_type")
  @@index([answerId])
  @@index([stepId])
  @@index([userId])
  @@map("feedback")
}

enum RepositoryStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TransactionType {
  PURCHASE
  USAGE
}

enum MeetingStatus {
  UPLOADED
  PROCESSING
  TRANSCRIBING
  SUMMARIZING
  COMPLETED
  FAILED
}
